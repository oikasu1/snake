<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🥷烏衣行(貪食蛇-學校客事100句)</title>
    <link href="https://oikasu1.github.io/kasuexam/kasu/fonts/twhei.css" rel="stylesheet">
    <style>

	body {
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		min-height: 100vh;
		margin: 0;
		background-color: #f5f5f5;
		color: #333;
	}

	#gameSettings {
		background-color: white;
		border-radius: 10px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		padding: 30px;
		margin-top: 30px;
		margin-bottom: 30px;
		max-width: 400px;
		width: 100%;
		user-select: none;
	}
	#gameSettings h2 {
		margin-top: 0;
		margin-bottom: 10px;
		color: #2c3e50;
		font-size: 24px;
		text-align: center;
	}
	#gameSettings div {
		margin-bottom: 0px;
	}
	#gameSettings label {
		display: inline-block;
		width: 80px;
		text-align: right;
		margin-left: 10px;
		font-weight: bold;
	}
	#gameSettings select {
		width: 250px;
		padding: 5px 15px;
		border: 1px solid #ddd;
		border-radius: 4px;
		background-color: #fff;
		font-size: 16px;
	}

	#speedSelection {
		text-align: center;
		margin-top: 20px;
		margin-bottom: 10px;
	}
	#speedSelection h2 {
		margin-bottom: 15px;
		color: #2c3e50;
		font-size: 24px;
	}
	button {
		padding: 8px 8px;
		margin: 5px 5px;
		font-size: 16px;
		cursor: pointer;
		background-color: #3498db;
		color: white;
		border: none;
		border-radius: 5px;
		transition: background-color 0.3s ease;
	}

	button:hover {
		background-color: #2980b9;
	}

	@media (max-width: 480px) {
		#gameSettings, #speedSelection {
			padding: 20px;
		}

		#gameSettings select {
			width: 150px;
		}

		button {
			padding: 8px 8px;
			margin: 5px 5px;
		}
	}
        #gameCanvas {
            border: 2px solid #bbb;
            max-width: 100%;
            max-height: 80vh;
			background-color: #fcfcfc;
            display: none;
        }

        #container {
            display: none;
            position: relative;
            width: 400px;
            text-align: center;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
        }

        #scoreDisplay,
        #wordDisplay,
        #timeDisplay {
            font-size: 14px;
            color: #555;
        }

        #wordDisplay {
            font-size: 18px;
            border: 1px solid #bbb;
            padding: 5px 10px;
            border-radius: 50px;
            color: #555;
			background-color: #fcfcfc;
        }

        .food-label {
            position: absolute;
            font-size: 18px;
        }

        select {
            margin: 10px;
            padding: 5px;
        }
    </style>
</head>

<body>



    <div id="gameSettings">
        <h2>🥷學校客事100句 (貪食蛇)</h2>
        <div>
            <label for="lessonSelect">關卡：</label>
            <select id="lessonSelect"></select>
        </div>
        <div>
            <label for="questionSelect">題目：</label>
            <select id="questionSelect"></select>
        </div>
        <div>
            <label for="answerSelect">答案：</label>
            <select id="answerSelect"></select>
        </div>
        <div>
            <label for="blockCountSelect">數量：</label>
            <select id="blockCountSelect">
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </div>
		<div id="speedSelection">			
			<button onclick="startGame('slow')">寬寬 🚲</button>
			<button onclick="startGame('normal')">普通 🚗</button>
			<button onclick="startGame('quick')">真緊 🛩️</button>
			<button onclick="startGame('fast')">足緊 🚀</button>
			<p>🏷️選方向：平板用滑螢幕，電腦用方向鍵。</p>
		</div>
    </div>


    <div id="container">
        <div id="header">
            <div id="scoreDisplay">✨得分: 0</div>
            <div id="wordDisplay"></div>
            <div id="timeDisplay">⏱️時間: 0</div>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div id="correctFoodLabel" class="food-label"></div>
        <div id="wrongFoodLabel" class="food-label"></div>
        <div id="wrongFoodLabel2" class="food-label"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const wordDisplay = document.getElementById('wordDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const correctFoodLabel = document.getElementById('correctFoodLabel');
        const wrongFoodLabel = document.getElementById('wrongFoodLabel');
		const container = document.getElementById('container');

        const gridSize = 20;
        let snake, correctFood, wrongFood, dx, dy, score, gameSpeed, gameInterval, elapsedTime, startTime;
        let currentWord, currentCorrectTranslation, currentWrongTranslation;
        let isAdjacent;

		const rightAudio = new Audio('right.mp3');
		const wrongAudio = new Audio('wrong.mp3');

		function playAudio(audio) {
				audio.currentTime = 0;
				audio.play();
		}


const myData = `
分類	國語	客語	拼音	注音	音檔
一、問好 00百句	你好	你好	henˋ hooˆ	ˋ ˆ	k009.mp3
一、問好 00百句	老師早	先生𠢕早	sienˇ senˇ ngauˋ zooˆ	ˇ ˇ ˋ ˆ	k010.mp3
一、問好 00百句	大家好	大家好	tai gaˇ hooˆ	 ˇ ˆ	k011.mp3
一、問好 00百句	客人好	人客好	nginˋ kaˊ hooˆ	ˋ ˊ ˆ	k012.mp3
`;

        let currentAudio = null;
        let headers = [];
        let wordPairs = [];
        let lessons = {};
        let allWords = [];
		let unusedWords = [];


        function processMyData() {
            const lines = myData.trim().split('\n');
            headers = lines[0].trim().split(/\t/); 
            let lessonCount = 0;
            let wordId = 0;

			allWords = []; // 重置
			lines.slice(1).forEach((line, index) => {
				const parts = line.trim().split(/\t/);
				if (parts.length >= 3) {
					const [lesson, ...rest] = parts;
					if (!lessons[lesson]) {
						lessons[lesson] = [];
						lessonCount++;
					}
					const newWord = {
						id: wordId++,
						lesson,
						...Object.fromEntries(headers.slice(1).map((header, i) => [header, rest[i] || '']))
					};
					lessons[lesson].push(newWord);
					allWords.push(newWord);
				} else if (parts.length === 2) {
                    const [value1, value2] = parts;
                    const lesson = `第${Math.floor(index / 10) + 1}組`;
                    if (!lessons[lesson]) {
                        lessons[lesson] = [];
                        lessonCount++;
                    }
                    const newWord = {
                        id: wordId++,
                        lesson,
                        [headers[0]]: value1,
                        [headers[1]]: value2
                    };
                    lessons[lesson].push(newWord);
                    allWords.push(newWord);
                }
            });
            populateSelects();
        }

function populateSelects() {
    const lessonSelect = document.getElementById('lessonSelect');
    const questionSelect = document.getElementById('questionSelect');
    const answerSelect = document.getElementById('answerSelect');

    // 清空現有選項
    lessonSelect.innerHTML = '';
    questionSelect.innerHTML = '';
    answerSelect.innerHTML = '';

    // 添加"全部"選項到課別
    const allOption = document.createElement('option');
    allOption.value = 'all';
    allOption.textContent = '全部';
    lessonSelect.appendChild(allOption);

    // 添加其他課程選項
    for (const lesson in lessons) {
        const option = document.createElement('option');
        option.value = lesson;
        option.textContent = lesson;
        lessonSelect.appendChild(option);
    }

    // 獲取非"音檔"和"分類"的標題
    const validHeaders = headers.filter(header => header !== '音檔' && header !== '分類');

    // 填充題目選單
    validHeaders.forEach(header => {
        const questionOption = document.createElement('option');
        questionOption.value = header;
        questionOption.textContent = header;
        questionSelect.appendChild(questionOption);
    });

    // 設置默認選項
    if (questionSelect.options.length > 0) {
        questionSelect.selectedIndex = 0;
    }

    // 初始填充答案選單
    updateAnswerSelect();

    // 添加事件監聽器
    questionSelect.addEventListener('change', updateAnswerSelect);
}

function updateAnswerSelect() {
    const questionSelect = document.getElementById('questionSelect');
    const answerSelect = document.getElementById('answerSelect');
    const selectedQuestion = questionSelect.value;
    const validHeaders = headers.filter(header => header !== '音檔' && header !== '分類');

    // 儲存答案選單的當前選擇
    const currentAnswerSelection = answerSelect.value;

    // 清空答案選單
    answerSelect.innerHTML = '';

    // 重新填充答案選單，排除在題目中選擇的選項
    validHeaders.forEach(header => {
        if (header !== selectedQuestion) {
            const option = document.createElement('option');
            option.value = header;
            option.textContent = header;
            answerSelect.appendChild(option);
        }
    });

    // 如果答案選單的之前選擇仍然可用，則選中它
    if (Array.from(answerSelect.options).some(option => option.value === currentAnswerSelection)) {
        answerSelect.value = currentAnswerSelection;
    } else {
        // 否則，選擇第一個可用選項
        answerSelect.selectedIndex = 0;
    }
}

		function updateSelectOptions(changedSelect, otherSelect) {
			const changedValue = changedSelect.value;
			const otherValue = otherSelect.value;
			const validHeaders = headers.filter(header => header !== '音檔' && header !== '分類');

			// 儲存其他選單的當前選擇
			const currentOtherSelection = otherSelect.value;

			// 清空其他選單
			otherSelect.innerHTML = '';

			// 重新填充其他選單，排除已在變更的選單中選擇的選項
			validHeaders.forEach(header => {
				if (header !== changedValue) {
					const option = document.createElement('option');
					option.value = header;
					option.textContent = header;
					otherSelect.appendChild(option);
				}
			});

			// 如果其他選單的之前選擇仍然可用，則選中它
			if (Array.from(otherSelect.options).some(option => option.value === currentOtherSelection)) {
				otherSelect.value = currentOtherSelection;
			} else {
				// 否則，選擇第一個可用選項
				otherSelect.selectedIndex = 0;
			}
		}

        function getWordStats(wordId) {
            const stats = JSON.parse(localStorage.getItem(`word_${wordId}`)) || {
                correct: 0,
                wrong: 0
            };
            return stats;
        }

        function updateWordStats(wordId, isCorrect) {
            const stats = getWordStats(wordId);
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.wrong++;
            }
            localStorage.setItem(`word_${wordId}`, JSON.stringify(stats));
        }

        function populateLessonSelect() {
            const lessonSelect = document.getElementById('lessonSelect');

            // 添加"全部"選項
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = '全部';
            lessonSelect.appendChild(allOption);

            // 添加其他課程選項
            for (const lesson in lessons) {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            }
        }

        // 在頁面加載時處理數據
        window.onload = function() {
            processMyData();
            populateSelects();
        };

		function initGame() {
			snake = [{ x: 10, y: 10 }];
			dx = 0;
			dy = 0;
			score = 0;
			startTime = Date.now();
			resetUnusedWords();
			generateNewWord();
		}

		function resetUnusedWords() {
			unusedWords = [...wordPairs];
		}

        function generateNewWord() {
			playAudio(rightAudio);
		


			// 如果所有單詞都已經使用過，重置未使用單詞列表
			if (unusedWords.length === 0) {
				resetUnusedWords();
			}
			

			// 從未使用的單詞中隨機選擇一個
			const randomIndex = Math.floor(Math.random() * unusedWords.length);
			const selectedWord = unusedWords[randomIndex];

			// 從未使用單詞列表中移除這個單詞
			unusedWords.splice(randomIndex, 1);

			currentWord = selectedWord.question;
			currentCorrectTranslation = selectedWord.answer;
			currentWordId = selectedWord.id;

			wordDisplay.textContent = `🥷 ${currentWord}`;

	
				currentAudio = new Audio(`https://oikasu1.github.io/kasu100/${selectedWord['音檔']}`);
				
				console.log(currentAudio)
				
				// 播放音檔兩次
				function playTwice() {
					currentAudio.play();
					currentAudio.onended = function() {
						if (this.playCount === undefined) {
							this.playCount = 1;
							currentAudio.play(); // 播放第二次
						} else {
							this.playCount = undefined; // 重置計數
						}
					};
				}

				playTwice();


			// 獲取選擇的方塊數量
			const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);

			// 生成正確答案的位置
			correctFood = generateFoodPosition();

			// 生成錯誤答案的位置，確保 y 座標不同
			do {
				wrongFood = generateFoodPosition();
			} while (wrongFood.y === correctFood.y);

			// 如果選擇了 3 個方塊，生成第二個錯誤答案的位置
			if (selectedBlockCount === 3) {
				do {
					wrongFood2 = generateFoodPosition();
				} while (
					wrongFood2.y === correctFood.y ||
					wrongFood2.y === wrongFood.y
				);
			} else {
				wrongFood2 = null; // 確保在 2 方塊模式下 wrongFood2 為 null
			}

            // 設置食物標籤位置和內容
            setFoodLabelPosition(correctFoodLabel, correctFood, currentCorrectTranslation);

            // 為錯誤答案生成不同的翻譯
            let wrongTranslations = wordPairs.filter(pair => pair.id !== selectedWord.id).map(pair => pair.answer);
            currentWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
            setFoodLabelPosition(wrongFoodLabel, wrongFood, currentWrongTranslation);

            if (selectedBlockCount === 3 && wrongFood2) {
                let secondWrongTranslation;
                do {
                    secondWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
                } while (secondWrongTranslation === currentWrongTranslation);
                setFoodLabelPosition(document.getElementById('wrongFoodLabel2'), wrongFood2, secondWrongTranslation);
                document.getElementById('wrongFoodLabel2').style.display = 'block';
            } else {
                document.getElementById('wrongFoodLabel2').style.display = 'none';
            }
        }

        function generateFoodPosition() {
            const centerX = Math.floor(canvas.width / (2 * gridSize));
            const centerY = Math.floor(canvas.height / (2 * gridSize));
            let x, y;
            do {
                x = Math.floor(Math.random() * (canvas.width / gridSize));
                y = Math.floor(Math.random() * (canvas.height / gridSize));
            } while ((x === centerX && y === centerY) || (x === centerX && y === centerY - 1));
            return {
                x,
                y
            };
        }



		function generateFoodPositions(count) {
			const positions = [];
			const maxY = canvas.height / gridSize - 1;
			const availableYs = [...Array(maxY + 1).keys()];

			for (let i = 0; i < count; i++) {
				if (availableYs.length === 0) {
					console.warn('Not enough vertical space for all blocks');
					break;
				}
				const yIndex = Math.floor(Math.random() * availableYs.length);
				const y = availableYs.splice(yIndex, 1)[0];
				const x = Math.floor(Math.random() * (canvas.width / gridSize));
				positions.push({ x, y });
			}

			return positions;
		}

        function setFoodLabelPosition(label, food, text) {
            const labelOffset = 25;
            const rightBoundary = canvas.width / gridSize;
            const leftBoundary = 0;

            if (food.x > rightBoundary - 5) {
                // food 靠近右邊界時，label 在 food 左邊
                label.style.left = '';
                label.style.right = `${(rightBoundary - food.x - 1) * gridSize + labelOffset}px`;
            } else if (food.x < 5) {
                // food 靠近左邊界時，label 在 food 右邊
                label.style.right = '';
                label.style.left = `${food.x * gridSize + labelOffset}px`;
            } else if (isAdjacent && food === correctFood) {
                // 如果兩個食物水平相近，並且是正確食物，label 在食物上方
                label.style.left = `${food.x * gridSize}px`;
                label.style.right = '';
            } else {
                // food 不靠近邊界時，label 在 food 上方
                label.style.left = `${food.x * gridSize + labelOffset}px`;
                label.style.right = '';
            }

            label.style.top = `${food.y * gridSize + 45}px`;
            label.textContent = text;
        }

        function drawSnake() {
            snake.forEach(segment => {
                ctx.fillStyle = 'green';
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });
        }

        function drawFood() {
            ctx.fillStyle = 'red';
            ctx.fillRect(correctFood.x * gridSize, correctFood.y * gridSize, gridSize - 2, gridSize - 2);
            ctx.fillRect(wrongFood.x * gridSize, wrongFood.y * gridSize, gridSize - 2, gridSize - 2);

            const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);
            if (selectedBlockCount === 3 && wrongFood2) {
                ctx.fillRect(wrongFood2.x * gridSize, wrongFood2.y * gridSize, gridSize - 2, gridSize - 2);
            }
        }

        function moveSnake() {
            const head = {
                x: snake[0].x + dx,
                y: snake[0].y + dy
            };
            snake.unshift(head);

            if (head.x === correctFood.x && head.y === correctFood.y) {
                score++;
                updateWordStats(currentWordId, true);
                generateNewWord();
                updateScore();
            } else if (head.x === wrongFood.x && head.y === wrongFood.y ||
                (wrongFood2 && head.x === wrongFood2.x && head.y === wrongFood2.y)) {
                updateWordStats(currentWordId, false);
                endGame();
            } else {
                snake.pop();
            }
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            moveSnake();
            drawSnake();
            drawFood();

            updateTime();

            if (checkCollision()) {
                endGame();
            }
        }

        function checkCollision() {
            const head = snake[0];
            return (
                head.x < 0 || head.x >= canvas.width / gridSize ||
                head.y < 0 || head.y >= canvas.height / gridSize ||
                snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y)
            );
        }

        function endGame() {
			playAudio(wrongAudio);
			// 停止當前正在播放的音檔（如果有）
			if (currentAudio) {
				currentAudio.pause();
				currentAudio.currentTime = 0;
			}
            alert(`遊戲結束！你的得分是: ${score}`);
            container.style.display = 'none';
            clearInterval(gameInterval);
            canvas.style.display = 'none';
            document.getElementById('gameSettings').style.display = 'block';
            document.getElementById('speedSelection').style.display = 'block';
            canvas.style.display = 'none';
            container.style.display = 'none';
            correctFoodLabel.style.display = 'none';
            wrongFoodLabel.style.display = 'none';
        }




        function handleKeyDown(event) {
            switch (event.key) {
                case 'ArrowUp':
                    if (dy === 0) {
                        dx = 0;
                        dy = -1;
                    }
                    break;
                case 'ArrowDown':
                    if (dy === 0) {
                        dx = 0;
                        dy = 1;
                    }
                    break;
                case 'ArrowLeft':
                    if (dx === 0) {
                        dx = -1;
                        dy = 0;
                    }
                    break;
                case 'ArrowRight':
                    if (dx === 0) {
                        dx = 1;
                        dy = 0;
                    }
                    break;
            }
        }

        function handleTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        }

        function handleTouchEnd(event) {
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 0 && dx === 0) {
                    dx = 1;
                    dy = 0;
                } else if (deltaX < 0 && dx === 0) {
                    dx = -1;
                    dy = 0;
                }
            } else {
                if (deltaY > 0 && dy === 0) {
                    dx = 0;
                    dy = 1;
                } else if (deltaY < 0 && dy === 0) {
                    dx = 0;
                    dy = -1;
                }
            }
        }


        function startGame(speed) {
            const selectedLesson = document.getElementById('lessonSelect').value;
            const selectedQuestion = document.getElementById('questionSelect').value;
            const selectedAnswer = document.getElementById('answerSelect').value;
            const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);
			scaleElement(container);

            if (selectedLesson === 'all') {
                wordPairs = allWords;
            } else {
                wordPairs = lessons[selectedLesson];
            }

            // 更新 currentWord 和 currentCorrectTranslation 的設置
            wordPairs = wordPairs.map(word => ({
                ...word,
                question: word[selectedQuestion] || '',
                answer: word[selectedAnswer] || ''
            }));

            switch (speed) {
                case 'slow':
                    gameSpeed = 400;
                    break;
                case 'normal':
                    gameSpeed = 300;
                    break;
                case 'quick':
                    gameSpeed = 250;
                    break;
                case 'fast':
                    gameSpeed = 200;
                    break;
            }
            document.getElementById('gameSettings').style.display = 'none';
            document.getElementById('speedSelection').style.display = 'none';
            canvas.style.display = 'block';
            container.style.display = 'block';
            correctFoodLabel.style.display = 'block';
            wrongFoodLabel.style.display = 'block';
			resetUnusedWords();
			initGame();
			gameInterval = setInterval(gameLoop, gameSpeed);
		}

        function updateScore() {
            scoreDisplay.textContent = `✨得分: ${score}`;
        }

        function updateTime() {
            elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            timeDisplay.textContent = `⏱時間: ${elapsedTime}`;
        }

        document.addEventListener('keydown', handleKeyDown);
        canvas.addEventListener('touchstart', handleTouchStart, false);
        canvas.addEventListener('touchend', handleTouchEnd, false);

        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, {
            passive: false
        });

		// 等比例放大
		function scaleElement(e) {
		  const w = e.offsetWidth;
		  const h = e.offsetHeight;
		  const windowWidth = window.innerWidth;
		  const windowHeight = window.innerHeight;

		  let scaleX;
		  let scaleY;

			scaleX = windowWidth / 400 * 0.9;
			scaleY = windowHeight / 451 * 0.9;
			container.style.marginTop = "10px";


		  const scale = Math.min(scaleX, scaleY);

		  // 設定最小縮放比例
		  const minScale = 1;
		  if (scale < minScale) {
			scale = minScale;
		  }

		  e.style.transform = `scale(${scale})`;

		}
scaleElement(container);
		// 視窗變動時，等比例放大
		window.addEventListener('resize', function() {
			scaleElement(container);
		});
    </script>
</body>

</html>
