<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü•∑ÁÉèË°£Ë°å(Ë≤™È£üËõá-Â≠∏Ê†°ÂÆ¢‰∫ã100Âè•)</title>
    <link href="https://oikasu1.github.io/kasuexam/kasu/fonts/twhei.css" rel="stylesheet">
    <style>

	body {
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		min-height: 100vh;
		margin: 0;
		background-color: #f5f5f5;
		color: #333;
	}

	#gameSettings {
		background-color: white;
		border-radius: 10px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		padding: 30px;
		margin-top: 30px;
		margin-bottom: 30px;
		max-width: 400px;
		width: 100%;
		user-select: none;
	}
	#gameSettings h2 {
		margin-top: 0;
		margin-bottom: 10px;
		color: #2c3e50;
		font-size: 24px;
		text-align: center;
	}
	#gameSettings div {
		margin-bottom: 0px;
	}
	#gameSettings label {
		display: inline-block;
		width: 80px;
		text-align: right;
		margin-left: 10px;
		font-weight: bold;
	}
	#gameSettings select {
		width: 250px;
		padding: 5px 15px;
		border: 1px solid #ddd;
		border-radius: 4px;
		background-color: #fff;
		font-size: 16px;
	}

	#speedSelection {
		text-align: center;
		margin-top: 20px;
		margin-bottom: 10px;
	}
	#speedSelection h2 {
		margin-bottom: 15px;
		color: #2c3e50;
		font-size: 24px;
	}
	button {
		padding: 8px 8px;
		margin: 5px 5px;
		font-size: 16px;
		cursor: pointer;
		background-color: #3498db;
		color: white;
		border: none;
		border-radius: 5px;
		transition: background-color 0.3s ease;
	}

	button:hover {
		background-color: #2980b9;
	}

	@media (max-width: 480px) {
		#gameSettings, #speedSelection {
			padding: 20px;
		}

		#gameSettings select {
			width: 150px;
		}

		button {
			padding: 8px 8px;
			margin: 5px 5px;
		}
	}
        #gameCanvas {
            border: 2px solid #bbb;
            max-width: 100%;
            max-height: 80vh;
			background-color: #fcfcfc;
            display: none;
        }

        #container {
            display: none;
            position: relative;
            width: 400px;
            text-align: center;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
        }

        #scoreDisplay,
        #wordDisplay,
        #timeDisplay {
            font-size: 14px;
            color: #555;
        }

        #wordDisplay {
            font-size: 18px;
            border: 1px solid #bbb;
            padding: 5px 10px;
            border-radius: 50px;
            color: #555;
			background-color: #fcfcfc;
        }

        .food-label {
            position: absolute;
            font-size: 18px;
        }

        select {
            margin: 10px;
            padding: 5px;
        }
    </style>
</head>

<body>



    <div id="gameSettings">
        <h2>ü•∑Â≠∏Ê†°ÂÆ¢‰∫ã100Âè• (Ë≤™È£üËõá)</h2>
        <div>
            <label for="lessonSelect">ÈóúÂç°Ôºö</label>
            <select id="lessonSelect"></select>
        </div>
        <div>
            <label for="questionSelect">È°åÁõÆÔºö</label>
            <select id="questionSelect"></select>
        </div>
        <div>
            <label for="answerSelect">Á≠îÊ°àÔºö</label>
            <select id="answerSelect"></select>
        </div>
        <div>
            <label for="blockCountSelect">Êï∏ÈáèÔºö</label>
            <select id="blockCountSelect">
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </div>
		<div id="speedSelection">			
			<button onclick="startGame('slow')">ÂØ¨ÂØ¨ üö≤</button>
			<button onclick="startGame('normal')">ÊôÆÈÄö üöó</button>
			<button onclick="startGame('quick')">ÁúüÁ∑ä üõ©Ô∏è</button>
			<button onclick="startGame('fast')">Ë∂≥Á∑ä üöÄ</button>
			<p>üè∑Ô∏èÈÅ∏ÊñπÂêëÔºöÂπ≥ÊùøÁî®ÊªëËû¢ÂπïÔºåÈõªËÖ¶Áî®ÊñπÂêëÈçµ„ÄÇ</p>
		</div>
    </div>


    <div id="container">
        <div id="header">
            <div id="scoreDisplay">‚ú®ÂæóÂàÜ: 0</div>
            <div id="wordDisplay"></div>
            <div id="timeDisplay">‚è±Ô∏èÊôÇÈñì: 0</div>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div id="correctFoodLabel" class="food-label"></div>
        <div id="wrongFoodLabel" class="food-label"></div>
        <div id="wrongFoodLabel2" class="food-label"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const wordDisplay = document.getElementById('wordDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const correctFoodLabel = document.getElementById('correctFoodLabel');
        const wrongFoodLabel = document.getElementById('wrongFoodLabel');
		const container = document.getElementById('container');

        const gridSize = 20;
        let snake, correctFood, wrongFood, dx, dy, score, gameSpeed, gameInterval, elapsedTime, startTime;
        let currentWord, currentCorrectTranslation, currentWrongTranslation;
        let isAdjacent;

		const rightAudio = new Audio('right.mp3');
		const wrongAudio = new Audio('wrong.mp3');

		function playAudio(audio) {
				audio.currentTime = 0;
				audio.play();
		}


const myData = `
ÂàÜÈ°û	ÂúãË™û	ÂÆ¢Ë™û	ÊãºÈü≥	Ê≥®Èü≥	Èü≥Ê™î
‰∏Ä„ÄÅÂïèÂ•Ω 00ÁôæÂè•	‰Ω†Â•Ω	‰Ω†Óá¥ÓàãÓàòÓàµÂ•ΩÓÜ•ÓáÇÓáß	henÀã hooÀÜ	ÓÑäÓÑòÓÑûÀã ÓÑäÓÑóÀÜ	k009.mp3
‰∏Ä„ÄÅÂïèÂ•Ω 00ÁôæÂè•	ËÄÅÂ∏´Êó©	ÂÖàÓá∑ÓàÜÓàóÓà¥ÁîüÓáæÓàãÓàòÓà¥†¢ïÓÜ±ÓáàÓá£Êó©ÓÜ≠ÓáÇÓáß	sienÀá senÀá ngauÀã zooÀÜ	ÓÑçÓÑ¢ÓÑùÀá ÓÑîÓÑòÓÑûÀá ÓÑ¶ÓÑõÀã ÓÑíÓÑóÀÜ	k010.mp3
‰∏Ä„ÄÅÂïèÂ•Ω 00ÁôæÂè•	Â§ßÂÆ∂Â•Ω	Â§ßÓÜ†ÓáÜÂÆ∂ÓÜ£ÓáÄÓá¢Â•ΩÓÜ•ÓáÇÓáß	tai gaÀá hooÀÜ	ÓÑÖÓÑô ÓÑàÓÑïÀá ÓÑäÓÑóÀÜ	k011.mp3
‰∏Ä„ÄÅÂïèÂ•Ω 00ÁôæÂè•	ÂÆ¢‰∫∫Â•Ω	‰∫∫ÓàÄÓàÜÓàòÓàµÂÆ¢ÓÜ§ÓáÄÓá°Â•ΩÓÜ•ÓáÇÓáß	nginÀã kaÀä hooÀÜ	ÓÑ¶ÓÑ¢ÓÑûÀã ÓÑâÓÑïÀä ÓÑäÓÑóÀÜ	k012.mp3
`;

        let currentAudio = null;
        let headers = [];
        let wordPairs = [];
        let lessons = {};
        let allWords = [];
		let unusedWords = [];


        function processMyData() {
            const lines = myData.trim().split('\n');
            headers = lines[0].trim().split(/\t/); 
            let lessonCount = 0;
            let wordId = 0;

			allWords = []; // ÈáçÁΩÆ
			lines.slice(1).forEach((line, index) => {
				const parts = line.trim().split(/\t/);
				if (parts.length >= 3) {
					const [lesson, ...rest] = parts;
					if (!lessons[lesson]) {
						lessons[lesson] = [];
						lessonCount++;
					}
					const newWord = {
						id: wordId++,
						lesson,
						...Object.fromEntries(headers.slice(1).map((header, i) => [header, rest[i] || '']))
					};
					lessons[lesson].push(newWord);
					allWords.push(newWord);
				} else if (parts.length === 2) {
                    const [value1, value2] = parts;
                    const lesson = `Á¨¨${Math.floor(index / 10) + 1}ÁµÑ`;
                    if (!lessons[lesson]) {
                        lessons[lesson] = [];
                        lessonCount++;
                    }
                    const newWord = {
                        id: wordId++,
                        lesson,
                        [headers[0]]: value1,
                        [headers[1]]: value2
                    };
                    lessons[lesson].push(newWord);
                    allWords.push(newWord);
                }
            });
            populateSelects();
        }

function populateSelects() {
    const lessonSelect = document.getElementById('lessonSelect');
    const questionSelect = document.getElementById('questionSelect');
    const answerSelect = document.getElementById('answerSelect');

    // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†Ö
    lessonSelect.innerHTML = '';
    questionSelect.innerHTML = '';
    answerSelect.innerHTML = '';

    // Ê∑ªÂä†"ÂÖ®ÈÉ®"ÈÅ∏È†ÖÂà∞Ë™≤Âà•
    const allOption = document.createElement('option');
    allOption.value = 'all';
    allOption.textContent = 'ÂÖ®ÈÉ®';
    lessonSelect.appendChild(allOption);

    // Ê∑ªÂä†ÂÖ∂‰ªñË™≤Á®ãÈÅ∏È†Ö
    for (const lesson in lessons) {
        const option = document.createElement('option');
        option.value = lesson;
        option.textContent = lesson;
        lessonSelect.appendChild(option);
    }

    // Áç≤ÂèñÈùû"Èü≥Ê™î"Âíå"ÂàÜÈ°û"ÁöÑÊ®ôÈ°å
    const validHeaders = headers.filter(header => header !== 'Èü≥Ê™î' && header !== 'ÂàÜÈ°û');

    // Â°´ÂÖÖÈ°åÁõÆÈÅ∏ÂñÆ
    validHeaders.forEach(header => {
        const questionOption = document.createElement('option');
        questionOption.value = header;
        questionOption.textContent = header;
        questionSelect.appendChild(questionOption);
    });

    // Ë®≠ÁΩÆÈªòË™çÈÅ∏È†Ö
    if (questionSelect.options.length > 0) {
        questionSelect.selectedIndex = 0;
    }

    // ÂàùÂßãÂ°´ÂÖÖÁ≠îÊ°àÈÅ∏ÂñÆ
    updateAnswerSelect();

    // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
    questionSelect.addEventListener('change', updateAnswerSelect);
}

function updateAnswerSelect() {
    const questionSelect = document.getElementById('questionSelect');
    const answerSelect = document.getElementById('answerSelect');
    const selectedQuestion = questionSelect.value;
    const validHeaders = headers.filter(header => header !== 'Èü≥Ê™î' && header !== 'ÂàÜÈ°û');

    // ÂÑ≤Â≠òÁ≠îÊ°àÈÅ∏ÂñÆÁöÑÁï∂ÂâçÈÅ∏Êìá
    const currentAnswerSelection = answerSelect.value;

    // Ê∏ÖÁ©∫Á≠îÊ°àÈÅ∏ÂñÆ
    answerSelect.innerHTML = '';

    // ÈáçÊñ∞Â°´ÂÖÖÁ≠îÊ°àÈÅ∏ÂñÆÔºåÊéíÈô§Âú®È°åÁõÆ‰∏≠ÈÅ∏ÊìáÁöÑÈÅ∏È†Ö
    validHeaders.forEach(header => {
        if (header !== selectedQuestion) {
            const option = document.createElement('option');
            option.value = header;
            option.textContent = header;
            answerSelect.appendChild(option);
        }
    });

    // Â¶ÇÊûúÁ≠îÊ°àÈÅ∏ÂñÆÁöÑ‰πãÂâçÈÅ∏Êìá‰ªçÁÑ∂ÂèØÁî®ÔºåÂâáÈÅ∏‰∏≠ÂÆÉ
    if (Array.from(answerSelect.options).some(option => option.value === currentAnswerSelection)) {
        answerSelect.value = currentAnswerSelection;
    } else {
        // Âê¶ÂâáÔºåÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÂèØÁî®ÈÅ∏È†Ö
        answerSelect.selectedIndex = 0;
    }
}

		function updateSelectOptions(changedSelect, otherSelect) {
			const changedValue = changedSelect.value;
			const otherValue = otherSelect.value;
			const validHeaders = headers.filter(header => header !== 'Èü≥Ê™î' && header !== 'ÂàÜÈ°û');

			// ÂÑ≤Â≠òÂÖ∂‰ªñÈÅ∏ÂñÆÁöÑÁï∂ÂâçÈÅ∏Êìá
			const currentOtherSelection = otherSelect.value;

			// Ê∏ÖÁ©∫ÂÖ∂‰ªñÈÅ∏ÂñÆ
			otherSelect.innerHTML = '';

			// ÈáçÊñ∞Â°´ÂÖÖÂÖ∂‰ªñÈÅ∏ÂñÆÔºåÊéíÈô§Â∑≤Âú®ËÆäÊõ¥ÁöÑÈÅ∏ÂñÆ‰∏≠ÈÅ∏ÊìáÁöÑÈÅ∏È†Ö
			validHeaders.forEach(header => {
				if (header !== changedValue) {
					const option = document.createElement('option');
					option.value = header;
					option.textContent = header;
					otherSelect.appendChild(option);
				}
			});

			// Â¶ÇÊûúÂÖ∂‰ªñÈÅ∏ÂñÆÁöÑ‰πãÂâçÈÅ∏Êìá‰ªçÁÑ∂ÂèØÁî®ÔºåÂâáÈÅ∏‰∏≠ÂÆÉ
			if (Array.from(otherSelect.options).some(option => option.value === currentOtherSelection)) {
				otherSelect.value = currentOtherSelection;
			} else {
				// Âê¶ÂâáÔºåÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÂèØÁî®ÈÅ∏È†Ö
				otherSelect.selectedIndex = 0;
			}
		}

        function getWordStats(wordId) {
            const stats = JSON.parse(localStorage.getItem(`word_${wordId}`)) || {
                correct: 0,
                wrong: 0
            };
            return stats;
        }

        function updateWordStats(wordId, isCorrect) {
            const stats = getWordStats(wordId);
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.wrong++;
            }
            localStorage.setItem(`word_${wordId}`, JSON.stringify(stats));
        }

        function populateLessonSelect() {
            const lessonSelect = document.getElementById('lessonSelect');

            // Ê∑ªÂä†"ÂÖ®ÈÉ®"ÈÅ∏È†Ö
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'ÂÖ®ÈÉ®';
            lessonSelect.appendChild(allOption);

            // Ê∑ªÂä†ÂÖ∂‰ªñË™≤Á®ãÈÅ∏È†Ö
            for (const lesson in lessons) {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            }
        }

        // Âú®È†ÅÈù¢Âä†ËºâÊôÇËôïÁêÜÊï∏Êìö
        window.onload = function() {
            processMyData();
            populateSelects();
        };

		function initGame() {
			snake = [{ x: 10, y: 10 }];
			dx = 0;
			dy = 0;
			score = 0;
			startTime = Date.now();
			resetUnusedWords();
			generateNewWord();
		}

		function resetUnusedWords() {
			unusedWords = [...wordPairs];
		}

        function generateNewWord() {
			playAudio(rightAudio);
		


			// Â¶ÇÊûúÊâÄÊúâÂñÆË©ûÈÉΩÂ∑≤Á∂ì‰ΩøÁî®ÈÅéÔºåÈáçÁΩÆÊú™‰ΩøÁî®ÂñÆË©ûÂàóË°®
			if (unusedWords.length === 0) {
				resetUnusedWords();
			}
			

			// ÂæûÊú™‰ΩøÁî®ÁöÑÂñÆË©û‰∏≠Èö®Ê©üÈÅ∏Êìá‰∏ÄÂÄã
			const randomIndex = Math.floor(Math.random() * unusedWords.length);
			const selectedWord = unusedWords[randomIndex];

			// ÂæûÊú™‰ΩøÁî®ÂñÆË©ûÂàóË°®‰∏≠ÁßªÈô§ÈÄôÂÄãÂñÆË©û
			unusedWords.splice(randomIndex, 1);

			currentWord = selectedWord.question;
			currentCorrectTranslation = selectedWord.answer;
			currentWordId = selectedWord.id;

			wordDisplay.textContent = `ü•∑ ${currentWord}`;

	
				currentAudio = new Audio(`https://oikasu1.github.io/kasu100/${selectedWord['Èü≥Ê™î']}`);
				
				console.log(currentAudio)
				
				// Êí≠ÊîæÈü≥Ê™îÂÖ©Ê¨°
				function playTwice() {
					currentAudio.play();
					currentAudio.onended = function() {
						if (this.playCount === undefined) {
							this.playCount = 1;
							currentAudio.play(); // Êí≠ÊîæÁ¨¨‰∫åÊ¨°
						} else {
							this.playCount = undefined; // ÈáçÁΩÆË®àÊï∏
						}
					};
				}

				playTwice();


			// Áç≤ÂèñÈÅ∏ÊìáÁöÑÊñπÂ°äÊï∏Èáè
			const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);

			// ÁîüÊàêÊ≠£Á¢∫Á≠îÊ°àÁöÑ‰ΩçÁΩÆ
			correctFood = generateFoodPosition();

			// ÁîüÊàêÈåØË™§Á≠îÊ°àÁöÑ‰ΩçÁΩÆÔºåÁ¢∫‰øù y Â∫ßÊ®ô‰∏çÂêå
			do {
				wrongFood = generateFoodPosition();
			} while (wrongFood.y === correctFood.y);

			// Â¶ÇÊûúÈÅ∏Êìá‰∫Ü 3 ÂÄãÊñπÂ°äÔºåÁîüÊàêÁ¨¨‰∫åÂÄãÈåØË™§Á≠îÊ°àÁöÑ‰ΩçÁΩÆ
			if (selectedBlockCount === 3) {
				do {
					wrongFood2 = generateFoodPosition();
				} while (
					wrongFood2.y === correctFood.y ||
					wrongFood2.y === wrongFood.y
				);
			} else {
				wrongFood2 = null; // Á¢∫‰øùÂú® 2 ÊñπÂ°äÊ®°Âºè‰∏ã wrongFood2 ÁÇ∫ null
			}

            // Ë®≠ÁΩÆÈ£üÁâ©Ê®ôÁ±§‰ΩçÁΩÆÂíåÂÖßÂÆπ
            setFoodLabelPosition(correctFoodLabel, correctFood, currentCorrectTranslation);

            // ÁÇ∫ÈåØË™§Á≠îÊ°àÁîüÊàê‰∏çÂêåÁöÑÁøªË≠Ø
            let wrongTranslations = wordPairs.filter(pair => pair.id !== selectedWord.id).map(pair => pair.answer);
            currentWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
            setFoodLabelPosition(wrongFoodLabel, wrongFood, currentWrongTranslation);

            if (selectedBlockCount === 3 && wrongFood2) {
                let secondWrongTranslation;
                do {
                    secondWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
                } while (secondWrongTranslation === currentWrongTranslation);
                setFoodLabelPosition(document.getElementById('wrongFoodLabel2'), wrongFood2, secondWrongTranslation);
                document.getElementById('wrongFoodLabel2').style.display = 'block';
            } else {
                document.getElementById('wrongFoodLabel2').style.display = 'none';
            }
        }

        function generateFoodPosition() {
            const centerX = Math.floor(canvas.width / (2 * gridSize));
            const centerY = Math.floor(canvas.height / (2 * gridSize));
            let x, y;
            do {
                x = Math.floor(Math.random() * (canvas.width / gridSize));
                y = Math.floor(Math.random() * (canvas.height / gridSize));
            } while ((x === centerX && y === centerY) || (x === centerX && y === centerY - 1));
            return {
                x,
                y
            };
        }



		function generateFoodPositions(count) {
			const positions = [];
			const maxY = canvas.height / gridSize - 1;
			const availableYs = [...Array(maxY + 1).keys()];

			for (let i = 0; i < count; i++) {
				if (availableYs.length === 0) {
					console.warn('Not enough vertical space for all blocks');
					break;
				}
				const yIndex = Math.floor(Math.random() * availableYs.length);
				const y = availableYs.splice(yIndex, 1)[0];
				const x = Math.floor(Math.random() * (canvas.width / gridSize));
				positions.push({ x, y });
			}

			return positions;
		}

        function setFoodLabelPosition(label, food, text) {
            const labelOffset = 25;
            const rightBoundary = canvas.width / gridSize;
            const leftBoundary = 0;

            if (food.x > rightBoundary - 5) {
                // food Èù†ËøëÂè≥ÈÇäÁïåÊôÇÔºålabel Âú® food Â∑¶ÈÇä
                label.style.left = '';
                label.style.right = `${(rightBoundary - food.x - 1) * gridSize + labelOffset}px`;
            } else if (food.x < 5) {
                // food Èù†ËøëÂ∑¶ÈÇäÁïåÊôÇÔºålabel Âú® food Âè≥ÈÇä
                label.style.right = '';
                label.style.left = `${food.x * gridSize + labelOffset}px`;
            } else if (isAdjacent && food === correctFood) {
                // Â¶ÇÊûúÂÖ©ÂÄãÈ£üÁâ©Ê∞¥Âπ≥Áõ∏ËøëÔºå‰∏¶‰∏îÊòØÊ≠£Á¢∫È£üÁâ©Ôºålabel Âú®È£üÁâ©‰∏äÊñπ
                label.style.left = `${food.x * gridSize}px`;
                label.style.right = '';
            } else {
                // food ‰∏çÈù†ËøëÈÇäÁïåÊôÇÔºålabel Âú® food ‰∏äÊñπ
                label.style.left = `${food.x * gridSize + labelOffset}px`;
                label.style.right = '';
            }

            label.style.top = `${food.y * gridSize + 45}px`;
            label.textContent = text;
        }

        function drawSnake() {
            snake.forEach(segment => {
                ctx.fillStyle = 'green';
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });
        }

        function drawFood() {
            ctx.fillStyle = 'red';
            ctx.fillRect(correctFood.x * gridSize, correctFood.y * gridSize, gridSize - 2, gridSize - 2);
            ctx.fillRect(wrongFood.x * gridSize, wrongFood.y * gridSize, gridSize - 2, gridSize - 2);

            const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);
            if (selectedBlockCount === 3 && wrongFood2) {
                ctx.fillRect(wrongFood2.x * gridSize, wrongFood2.y * gridSize, gridSize - 2, gridSize - 2);
            }
        }

        function moveSnake() {
            const head = {
                x: snake[0].x + dx,
                y: snake[0].y + dy
            };
            snake.unshift(head);

            if (head.x === correctFood.x && head.y === correctFood.y) {
                score++;
                updateWordStats(currentWordId, true);
                generateNewWord();
                updateScore();
            } else if (head.x === wrongFood.x && head.y === wrongFood.y ||
                (wrongFood2 && head.x === wrongFood2.x && head.y === wrongFood2.y)) {
                updateWordStats(currentWordId, false);
                endGame();
            } else {
                snake.pop();
            }
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            moveSnake();
            drawSnake();
            drawFood();

            updateTime();

            if (checkCollision()) {
                endGame();
            }
        }

        function checkCollision() {
            const head = snake[0];
            return (
                head.x < 0 || head.x >= canvas.width / gridSize ||
                head.y < 0 || head.y >= canvas.height / gridSize ||
                snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y)
            );
        }

        function endGame() {
			playAudio(wrongAudio);
			// ÂÅúÊ≠¢Áï∂ÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÈü≥Ê™îÔºàÂ¶ÇÊûúÊúâÔºâ
			if (currentAudio) {
				currentAudio.pause();
				currentAudio.currentTime = 0;
			}
            alert(`ÈÅäÊà≤ÁµêÊùüÔºÅ‰Ω†ÁöÑÂæóÂàÜÊòØ: ${score}`);
            container.style.display = 'none';
            clearInterval(gameInterval);
            canvas.style.display = 'none';
            document.getElementById('gameSettings').style.display = 'block';
            document.getElementById('speedSelection').style.display = 'block';
            canvas.style.display = 'none';
            container.style.display = 'none';
            correctFoodLabel.style.display = 'none';
            wrongFoodLabel.style.display = 'none';
        }




        function handleKeyDown(event) {
            switch (event.key) {
                case 'ArrowUp':
                    if (dy === 0) {
                        dx = 0;
                        dy = -1;
                    }
                    break;
                case 'ArrowDown':
                    if (dy === 0) {
                        dx = 0;
                        dy = 1;
                    }
                    break;
                case 'ArrowLeft':
                    if (dx === 0) {
                        dx = -1;
                        dy = 0;
                    }
                    break;
                case 'ArrowRight':
                    if (dx === 0) {
                        dx = 1;
                        dy = 0;
                    }
                    break;
            }
        }

        function handleTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        }

        function handleTouchEnd(event) {
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 0 && dx === 0) {
                    dx = 1;
                    dy = 0;
                } else if (deltaX < 0 && dx === 0) {
                    dx = -1;
                    dy = 0;
                }
            } else {
                if (deltaY > 0 && dy === 0) {
                    dx = 0;
                    dy = 1;
                } else if (deltaY < 0 && dy === 0) {
                    dx = 0;
                    dy = -1;
                }
            }
        }


        function startGame(speed) {
            const selectedLesson = document.getElementById('lessonSelect').value;
            const selectedQuestion = document.getElementById('questionSelect').value;
            const selectedAnswer = document.getElementById('answerSelect').value;
            const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);
			scaleElement(container);

            if (selectedLesson === 'all') {
                wordPairs = allWords;
            } else {
                wordPairs = lessons[selectedLesson];
            }

            // Êõ¥Êñ∞ currentWord Âíå currentCorrectTranslation ÁöÑË®≠ÁΩÆ
            wordPairs = wordPairs.map(word => ({
                ...word,
                question: word[selectedQuestion] || '',
                answer: word[selectedAnswer] || ''
            }));

            switch (speed) {
                case 'slow':
                    gameSpeed = 400;
                    break;
                case 'normal':
                    gameSpeed = 300;
                    break;
                case 'quick':
                    gameSpeed = 250;
                    break;
                case 'fast':
                    gameSpeed = 200;
                    break;
            }
            document.getElementById('gameSettings').style.display = 'none';
            document.getElementById('speedSelection').style.display = 'none';
            canvas.style.display = 'block';
            container.style.display = 'block';
            correctFoodLabel.style.display = 'block';
            wrongFoodLabel.style.display = 'block';
			resetUnusedWords();
			initGame();
			gameInterval = setInterval(gameLoop, gameSpeed);
		}

        function updateScore() {
            scoreDisplay.textContent = `‚ú®ÂæóÂàÜ: ${score}`;
        }

        function updateTime() {
            elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            timeDisplay.textContent = `‚è±ÊôÇÈñì: ${elapsedTime}`;
        }

        document.addEventListener('keydown', handleKeyDown);
        canvas.addEventListener('touchstart', handleTouchStart, false);
        canvas.addEventListener('touchend', handleTouchEnd, false);

        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, {
            passive: false
        });

		// Á≠âÊØî‰æãÊîæÂ§ß
		function scaleElement(e) {
		  const w = e.offsetWidth;
		  const h = e.offsetHeight;
		  const windowWidth = window.innerWidth;
		  const windowHeight = window.innerHeight;

		  let scaleX;
		  let scaleY;

			scaleX = windowWidth / 400 * 0.9;
			scaleY = windowHeight / 451 * 0.9;
			container.style.marginTop = "10px";


		  const scale = Math.min(scaleX, scaleY);

		  // Ë®≠ÂÆöÊúÄÂ∞èÁ∏ÆÊîæÊØî‰æã
		  const minScale = 1;
		  if (scale < minScale) {
			scale = minScale;
		  }

		  e.style.transform = `scale(${scale})`;

		}
scaleElement(container);
		// Ë¶ñÁ™óËÆäÂãïÊôÇÔºåÁ≠âÊØî‰æãÊîæÂ§ß
		window.addEventListener('resize', function() {
			scaleElement(container);
		});
    </script>
</body>

</html>
